# Avancement de la Branche - D√©veloppement Forum

## Informations de Branche

**Branche actuelle**: feature/forum-tables
**Branche parent**: feature/forum
**Cr√©√©e le**: 2025-10-30
**Objectif**: Cr√©ation des tables de base de donn√©es pour le syst√®me de forum complet (ethnies, factions, clans, characters, categories, sections, topics, posts)

---

## Contexte

Suite √† la pr√©paration de la table `users` pour le forum (branche feature/forum-users-update), cette branche impl√©mente l'int√©gralit√© du syst√®me de forum avec:
- Tables de jeu: ethnies, factions, clans, characters
- Tables de forum: categories, sections, topics, posts
- Relations complexes entre toutes ces entit√©s
- Syst√®me de soft-delete (paranoid mode)
- Hi√©rarchie de sections
- Double syst√®me d'auteurs (user OU character) pour topics et posts
- Gestion des permissions par faction/clan
- Donn√©es de test compl√®tes (seeders)

---

## T√¢ches de la Branche

### Migrations (9 nouvelles migrations)
- [x] 003-create-ethnies.js: Table de r√©f√©rence des ethnies
- [x] 004-create-factions.js: Table des factions avec soft-delete
- [x] 005-create-clans.js: Table des clans avec soft-delete
- [x] 006-create-characters.js: Table des personnages avec soft-delete
- [x] 007-create-categories.js: Table des cat√©gories de forum
- [x] 008-create-sections.js: Table des sections avec hi√©rarchie
- [x] 009-create-topics.js: Table des topics avec double auteur
- [x] 010-create-posts.js: Table des posts avec double auteur
- [x] 011-add-foreign-keys-constraints.js: R√©solution des r√©f√©rences circulaires

### Mod√®les Sequelize (9 mod√®les)
- [x] Ethnie.js: Mod√®le sans timestamps
- [x] Faction.js: Mod√®le avec paranoid mode
- [x] Clan.js: Mod√®le avec paranoid mode
- [x] Character.js: Mod√®le avec paranoid mode
- [x] Category.js: Mod√®le avec paranoid mode
- [x] Section.js: Mod√®le avec paranoid mode et auto-r√©f√©rence
- [x] Topic.js: Mod√®le avec paranoid mode et validation XOR auteur
- [x] Post.js: Mod√®le avec paranoid mode et validation XOR auteur
- [x] index.js: Fichier central d√©finissant toutes les associations

### Seeders (8 nouveaux seeders)
- [x] 001-demo-users.js: Modification pour IDs explicites
- [x] 002-demo-ethnies.js: 5 ethnies
- [x] 003-demo-factions.js: 5 factions
- [x] 004-demo-clans.js: 6 clans
- [x] 005-demo-characters.js: 9 characters (4 PCs, 5 NPCs)
- [x] 006-demo-categories.js: 5 cat√©gories
- [x] 007-demo-sections.js: 10 sections (avec hi√©rarchie)
- [x] 008-demo-topics.js: 7 topics
- [x] 009-demo-posts.js: 10 posts avec dialogues RP

### Scripts et Commandes
- [x] clearTable.js: Script pour vider une table sp√©cifique
- [x] db:clear: Commande npm pour vider des tables
- [x] db:seed:undo: Modifi√© pour annuler tous les seeders
- [x] Suppression de db:seed:undo:all (redondant)

### Documentation
- [x] database.md: Documentation compl√®te des tables et relations
- [x] database.md: Documentation des commandes seeders et limitations
- [x] branch-progress.md: Mise √† jour avec progression branche forum-tables

---

## Commits

### Historique pr√©c√©dent (branche feature/forum)
- Commit 1: feat(backend): mise √† jour table users pour le forum
- Commit 2: docs(forum): ajout documentation s√©curit√© et progression branche users
- Commit 3: Merge branch 'feature/forum-users-update' into feature/forum

### Branche feature/forum-tables (en cours)

#### Commit √† venir: Cr√©ation compl√®te des tables forum
**Message pr√©vu**:
```
feat(forum): cr√©ation tables de base de donn√©es forum complet

- 9 migrations: ethnies, factions, clans, characters, categories, sections, topics, posts + contraintes FK
- 9 mod√®les Sequelize avec associations compl√®tes
- 8 seeders avec donn√©es de test compl√®tes
- Script clearTable.js pour vider tables individuelles
- Commande db:clear pour gestion granulaire
- Documentation compl√®te dans database.md et branch-progress.md

R√©solution r√©f√©rences circulaires via migration 011
Validation XOR pour auteurs (user OU character) dans models
Soft-delete (paranoid) sur toutes tables sauf ethnies
```

**Fichiers cr√©√©s**:
- backend/migrations/003-create-ethnies.js
- backend/migrations/004-create-factions.js
- backend/migrations/005-create-clans.js
- backend/migrations/006-create-characters.js
- backend/migrations/007-create-categories.js
- backend/migrations/008-create-sections.js
- backend/migrations/009-create-topics.js
- backend/migrations/010-create-posts.js
- backend/migrations/011-add-foreign-keys-constraints.js
- backend/src/models/Ethnie.js
- backend/src/models/Faction.js
- backend/src/models/Clan.js
- backend/src/models/Character.js
- backend/src/models/Category.js
- backend/src/models/Section.js
- backend/src/models/Topic.js
- backend/src/models/Post.js
- backend/src/models/index.js
- backend/seeders/002-demo-ethnies.js
- backend/seeders/003-demo-factions.js
- backend/seeders/004-demo-clans.js
- backend/seeders/005-demo-characters.js
- backend/seeders/006-demo-categories.js
- backend/seeders/007-demo-sections.js
- backend/seeders/008-demo-topics.js
- backend/seeders/009-demo-posts.js
- backend/src/scripts/clearTable.js

**Fichiers modifi√©s**:
- backend/package.json (commandes db:clear, db:seed:undo)
- backend/seeders/001-demo-users.js (IDs explicites)
- docs/architecture/database.md (documentation compl√®te)
- docs/progress/branch-progress.md (mise √† jour progression)

---

## Architecture des Donn√©es

### Tables cr√©√©es (8 tables)

1. **ethnies**: Table de r√©f√©rence statique (pas de soft-delete)
2. **factions**: Organisations majeures avec ethnie optionnelle
3. **clans**: Sous-groupes des factions avec leader
4. **characters**: Personnages joueurs et NPCs
5. **categories**: Cat√©gories principales du forum
6. **sections**: Sections hi√©rarchiques avec permissions faction/clan
7. **topics**: Sujets de discussion avec auteur user OU character
8. **posts**: Messages avec auteur user OU character

### Relations Cl√©s

- **R√©f√©rences circulaires** (r√©solues dans migration 011):
  - factions.main_clan_id ‚Üí clans.id
  - clans.leader_character_id ‚Üí characters.id

- **Hi√©rarchie**:
  - sections.parent_section_id ‚Üí sections.id (auto-r√©f√©rence)

- **Double auteur (XOR)**:
  - topics: author_user_id XOR author_character_id
  - posts: author_user_id XOR author_character_id

- **Permissions**:
  - sections peuvent √™tre priv√©es (faction/clan)
  - topics h√©ritent des permissions de la section

---

## Probl√®mes R√©solus

### 1. R√©f√©rences Circulaires FK
**Probl√®me**: Migration 004 (factions) r√©f√©ren√ßait clans.id avant cr√©ation, et migration 005 (clans) r√©f√©ren√ßait characters.id avant cr√©ation.

**Solution**:
- Migrations 004 et 005 cr√©ent les colonnes sans FK constraints
- Migration 011 ajoute les FK constraints apr√®s cr√©ation de toutes les tables
- Rollback corrig√©: supprimer FK AVANT indexes

### 2. CHECK Constraints MySQL sur colonnes FK
**Probl√®me**: MySQL n'autorise pas les CHECK constraints sur colonnes avec FK.
```
ERROR: Column 'author_user_id' cannot be used in a check constraint 'chk_topics_author'
```

**Solution**:
- Suppression des CHECK constraints des migrations
- Validation XOR impl√©ment√©e dans les mod√®les Sequelize
```javascript
validate: {
  authorXor() {
    const hasUser = this.author_user_id !== null;
    const hasCharacter = this.author_character_id !== null;
    if (hasUser && hasCharacter) throw new Error('Un seul type d\'auteur');
    if (!hasUser && !hasCharacter) throw new Error('Un auteur requis');
  }
}
```

### 3. Seeders - Contraintes FK avec auto-increment
**Probl√®me**: Users cr√©√©s avec auto-increment (7, 8, 9) mais characters attendaient IDs 1, 2, 3.

**Solution**: Ajout d'IDs explicites dans seeder 001-demo-users.js
```javascript
{ id: 1, username: 'admin', ... }
```

### 4. Sequelize CLI ne track pas les seeders individuels
**Probl√®me**: Impossible d'annuler uniquement le dernier seeder.

**Solution**:
- db:seed:undo modifi√© pour annuler TOUS les seeders
- db:seed:undo:all supprim√© (redondant)
- Ajout commande db:clear pour vider tables individuelles
- Documentation de la limitation

---

## Tests Effectu√©s

### Test 1: Migrations compl√®tes
```bash
npm run db:migrate:undo:all
npm run db:migrate
```
‚úì **R√©sultat**: Toutes les migrations (001-011) s'ex√©cutent sans erreur
‚úì **Rollback**: Toutes les migrations se rollback correctement

### Test 2: Seeders complets
```bash
npm run db:seed
```
‚úì **R√©sultat**: Tous les seeders (001-009) s'ex√©cutent sans erreur
‚úì **Donn√©es**: 3 users, 5 ethnies, 5 factions, 6 clans, 9 characters, 5 categories, 10 sections, 7 topics, 10 posts

### Test 3: Commande db:seed:undo
```bash
npm run db:seed:undo
```
‚úì **R√©sultat**: Tous les seeders sont annul√©s (toutes les tables vid√©es)

### Test 4: Commande db:clear
```bash
npm run db:clear -- posts
```
‚úì **R√©sultat**: Table posts vid√©e sans affecter les autres tables
‚úì **FK**: D√©sactivation temporaire des contraintes FK fonctionne

### Test 5: Validation XOR dans mod√®les
‚úì **R√©sultat**: Sequelize valide correctement l'exclusivit√© des auteurs (user OU character)

---

## √âtat Actuel de la Branche

### ‚úÖ Compl√©t√© (branche feature/forum-tables)
- [x] 9 migrations cr√©√©es et test√©es (003-011)
- [x] 9 mod√®les Sequelize avec associations
- [x] 8 seeders cr√©√©s avec donn√©es de test compl√®tes
- [x] Script clearTable.js cr√©√©
- [x] Commandes db:clear et db:seed:undo mises √† jour
- [x] R√©solution r√©f√©rences circulaires (migration 011)
- [x] Validation XOR auteurs impl√©ment√©e
- [x] Soft-delete sur toutes tables (sauf ethnies)
- [x] Documentation compl√®te mise √† jour
- [x] Tests complets effectu√©s

### üìã Prochaines Actions
1. **Imm√©diat**: Commit, push et merge avec feature/forum
2. **Backend API**: Cr√©er routes CRUD pour toutes les tables
3. **Permissions**: Impl√©menter syst√®me de permissions bas√© sur r√¥les/factions/clans
4. **Frontend**: Cr√©er interfaces pour cat√©gories, sections, topics, posts
5. **RP**: Impl√©menter syst√®me de roleplay avec s√©lection de character

---

## Notes de D√©veloppement

### D√©cisions Techniques

**1. Migration 011 pour r√©f√©rences circulaires**
- Permet de cr√©er toutes les tables avant d'ajouter les FK constraints complexes
- Pattern r√©utilisable pour futures relations circulaires
- Rollback s√©curis√©: FK supprim√©es avant indexes

**2. Validation XOR dans mod√®les plut√¥t que CHECK constraints**
- MySQL ne supporte pas CHECK sur colonnes avec FK
- Validation Sequelize plus flexible et maintenable
- Messages d'erreur personnalisables en fran√ßais

**3. Soft-delete (paranoid) sur toutes tables sauf ethnies**
- Permet de conserver l'historique des posts/topics supprim√©s
- Ethnie = table de r√©f√©rence statique, pas de soft-delete n√©cessaire
- Facilite la mod√©ration et la r√©cup√©ration de contenu

**4. Double syst√®me d'auteurs (user OU character)**
- Permet le roleplay in-game (auteur = character)
- Permet les posts hors-jeu (auteur = user)
- Champ author_name conserve le nom apr√®s suppression

**5. Script clearTable.js vs seeders**
- Sequelize CLI ne track pas les seeders individuellement
- clearTable permet un vidage granulaire table par table
- Plus efficace pour le d√©veloppement et les tests

---

## Scripts Utiles

### R√©initialiser compl√®tement la base de donn√©es
```bash
cd backend
npm run db:reset
```
Cette commande: undo all migrations ‚Üí migrate ‚Üí seed

### Vider une table sp√©cifique
```bash
npm run db:clear -- posts
npm run db:clear -- topics
npm run db:clear -- characters
```

### Migrations uniquement
```bash
npm run db:migrate              # Ex√©cuter toutes les migrations
npm run db:migrate:undo         # Annuler la derni√®re
npm run db:migrate:undo:all     # Tout annuler
```

### Seeders uniquement
```bash
npm run db:seed                 # Ex√©cuter tous les seeders
npm run db:seed:undo            # Annuler TOUS les seeders
```

---

**Derni√®re mise √† jour**: 2025-10-30
**Statut**: ‚úÖ Tables forum cr√©√©es - Pr√™t pour d√©veloppement API backend
