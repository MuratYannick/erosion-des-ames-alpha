# Avancement de la Branche - Mise √† jour Users pour Forum

## Informations de Branche

**Branche actuelle**: feature/forum
**Branche parent**: main
**Cr√©√©e le**: 2025-10-24
**Objectif**: Modification de la table users pour supporter les fonctionnalit√©s du forum

---

## Contexte

Dans le cadre de la pr√©paration du syst√®me de forum, la table `users` doit √™tre enrichie pour supporter:
- La gestion des r√¥les utilisateurs (admin, moderator, game-master, player)
- La v√©rification des emails
- L'acceptation des r√®glements du forum et des CGU
- La possibilit√© de cr√©er plusieurs comptes par email (pour certains utilisateurs autoris√©s)

Cette branche pr√©pare le d√©veloppement du forum, qui sera une fonctionnalit√© importante de l'application.

---

## T√¢ches de la Branche

### Modifications de la table users
- [x] Retirer la contrainte UNIQUE sur la colonne email
- [x] Ajouter colonne `email_verified` (BOOLEAN, d√©faut: false)
- [x] Ajouter colonne `role` (ENUM: admin/moderator/game-master/player, d√©faut: player)
- [x] Ajouter colonne `forum_rules_accepted` (BOOLEAN, d√©faut: false)
- [x] Ajouter colonne `forum_rules_accepted_at` (DATE nullable)
- [x] Ajouter colonne `terms_accepted` (BOOLEAN, d√©faut: false)
- [x] Ajouter colonne `terms_accepted_at` (DATE nullable)
- [x] Ajouter index sur la colonne `role` pour performance

### Backend
- [x] Cr√©er migration 002-update-users-for-forum.js
- [x] Mettre √† jour le mod√®le User.js avec les nouveaux champs
- [x] Mettre √† jour le seeder 001-demo-users.js
- [x] Cr√©er script utilitaire showUsersTable.js

### S√©curit√©
- [x] V√©rifier que la route /api/auth/register interdit toujours les emails en double
- [x] V√©rifier que le formulaire Register g√®re correctement l'erreur 409
- [x] Documenter les protections applicatives (docs/security/email-verification.md)

---

## Commits

### Commit 1: Mise √† jour table users
**Message**: feat(backend): mise √† jour table users pour le forum

**Fichiers cr√©√©s**:
- backend/migrations/002-update-users-for-forum.js
- backend/src/scripts/showUsersTable.js
- docs/security/email-verification.md

**Fichiers modifi√©s**:
- backend/src/models/User.js (ajout 6 nouveaux champs)
- backend/seeders/001-demo-users.js (ajout donn√©es pour nouveaux champs)

**D√©tails techniques**:
- Utilisation de requ√™tes SQL brutes pour supprimer la contrainte unique email
- Ajout de 6 nouveaux champs avec validations appropri√©es
- Cr√©ation de donn√©es de test avec r√¥les vari√©s (admin, players)
- Index cr√©√© sur `role` pour optimiser les requ√™tes de filtrage par r√¥le

### Commit 2: Documentation
**Message**: docs(forum): ajout documentation s√©curit√© et progression branche users

**Fichiers cr√©√©s**:
- docs/BRANCH_PROGRESS_FORUM_USERS.md

### Commit 3: Merge sous-branche
**Message**: Merge branch 'feature/forum-users-update' into feature/forum

**D√©tails**: Int√©gration compl√®te de la mise √† jour de la table users

---

## Architecture des Donn√©es

### Nouveaux champs User

```javascript
{
  email_verified: BOOLEAN (false),          // Email v√©rifi√© ou non
  role: ENUM (player),                      // admin|moderator|game-master|player
  forum_rules_accepted: BOOLEAN (false),    // R√®glement forum accept√©
  forum_rules_accepted_at: DATE (null),     // Date acceptation r√®glement
  terms_accepted: BOOLEAN (false),          // CGU accept√©es
  terms_accepted_at: DATE (null)            // Date acceptation CGU
}
```

### R√¥les disponibles
- **admin**: Administrateur avec tous les droits
- **moderator**: Mod√©rateur du forum
- **game-master**: Ma√Ætre du jeu
- **player**: Joueur standard (r√¥le par d√©faut)

### Donn√©es de test (seeders)

| Username | Email | Role | Email Verified | Forum Rules | Terms |
|----------|-------|------|----------------|-------------|-------|
| admin | admin@erosion-des-ames.com | admin | ‚úì | ‚úì | ‚úì |
| testuser | test@example.com | player | ‚úì | ‚úì | ‚úì |
| player1 | player1@example.com | player | ‚úó | ‚úó | ‚úì |

---

## Probl√®mes R√©solus

### 1. Suppression contrainte UNIQUE email
**Probl√®me**: La m√©thode Sequelize `changeColumn` ne supprimait pas correctement la contrainte unique en MySQL.

**Solution**: Utilisation de requ√™tes SQL brutes :
```javascript
await queryInterface.sequelize.query('ALTER TABLE users DROP INDEX email');
await queryInterface.sequelize.query('ALTER TABLE users DROP INDEX idx_email');
```

### 2. MySQL cr√©ait automatiquement un nouvel index unique
**Probl√®me**: Apr√®s la migration, MySQL cr√©ait un index `email_2` unique automatiquement.

**Solution**: Suppression manuelle de l'index apr√®s v√©rification de la structure.

---

## S√©curit√© - Protection Email

Malgr√© la suppression de la contrainte UNIQUE au niveau de la base de donn√©es, les protections suivantes restent actives:

### Backend ([authController.js:28-45](../backend/src/controllers/authController.js))
```javascript
const existingUser = await User.findOne({
  where: { [Op.or]: [{ email }, { username }] }
});
if (existingUser?.email === email) {
  return res.status(409).json({ error: 'Cet email est d√©j√† utilis√©' });
}
```

### Frontend ([Register.jsx:61](../frontend/src/pages/Register.jsx))
```javascript
const wasRedirected = handleError(err, navigate, { skipValidationErrors: true });
if (!wasRedirected) {
  setError(err.message); // Affiche "Cet email est d√©j√† utilis√©"
}
```

### Tests effectu√©s
‚úì Route /register refuse les emails en double (HTTP 409)
‚úì Route /register refuse les usernames en double (HTTP 409)
‚úì Frontend affiche l'erreur dans le formulaire (pas de redirection)
‚úì Base de donn√©es accepte les doublons (contrainte supprim√©e)

**Documentation compl√®te**: [email-verification.md](../security/email-verification.md)

---

## Tests de Migration

### Test 1: Undo/Redo complet
```bash
npm run db:migrate:undo:all
npm run db:migrate
npm run db:seed
```
‚úì **R√©sultat**: Migration et seeder fonctionnent correctement

### Test 2: Structure de la table
```bash
node src/scripts/showUsersTable.js
```
‚úì **R√©sultat**:
- 14 colonnes au total (8 originales + 6 nouvelles)
- Email n'est plus UNIQUE
- Index cr√©√© sur role
- Tous les champs DATE incluent l'heure

### Test 3: Insertion email dupliqu√©
```bash
INSERT INTO users (username, email, ...)
VALUES ('admin2', 'admin@erosion-des-ames.com', ...)
```
‚úì **R√©sultat**: Insertion r√©ussie - contrainte unique bien supprim√©e

---

## √âtat Actuel de la Branche

### ‚úÖ Compl√©t√©
- [x] Migration 002-update-users-for-forum.js cr√©√©e et test√©e
- [x] Mod√®le User.js mis √† jour
- [x] Seeder 001-demo-users.js mis √† jour
- [x] Script utilitaire showUsersTable.js cr√©√©
- [x] Contrainte unique email supprim√©e
- [x] 6 nouveaux champs ajout√©s et fonctionnels
- [x] Protection applicative email v√©rifi√©e
- [x] Documentation s√©curit√© cr√©√©e
- [x] Tests complets effectu√©s
- [x] Merge avec feature/forum effectu√©
- [x] Push vers GitHub effectu√©

### üìã Prochaines Actions
1. Continuer d√©veloppement forum (cat√©gories, topics, posts...)
2. Impl√©menter syst√®me de permissions bas√© sur les r√¥les
3. Cr√©er interface de v√©rification email
4. Cr√©er pages d'acceptation des r√®gles et CGU

---

## Notes de D√©veloppement

### D√©cisions Techniques

**1. Suppression contrainte UNIQUE email**
- Permet aux utilisateurs autoris√©s d'avoir plusieurs comptes
- Protection maintenue au niveau applicatif via authController
- Future route d√©di√©e pour cr√©ation de comptes multiples

**2. Choix de l'ENUM pour role**
- Garantit l'int√©grit√© des donn√©es (valeurs limit√©es)
- Index cr√©√© pour optimiser les requ√™tes de filtrage
- Facilite l'ajout de permissions bas√©es sur les r√¥les

**3. S√©paration forum_rules et terms**
- Permet une acceptation ind√©pendante
- Tra√ßabilit√© avec dates d'acceptation
- Conformit√© juridique (CGU) et mod√©ration (r√®glement forum)

### Utilisation Future

Les nouveaux champs seront utilis√©s pour:
- Syst√®me de permissions bas√© sur les r√¥les
- V√©rification email obligatoire pour certaines actions
- Acceptation obligatoire des r√®gles avant acc√®s au forum
- Tra√ßabilit√© des acceptations (date/heure)

---

## Scripts Utiles

### Voir la structure de la table users
```bash
node backend/src/scripts/showUsersTable.js
```

### R√©initialiser la base de donn√©es
```bash
npm run db:migrate:undo:all
npm run db:migrate
npm run db:seed
```

### Tester la route register
```bash
curl -w "\nHTTP: %{http_code}\n" -X POST http://localhost:3000/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{"username":"test","email":"existing@email.com","password":"123456"}'
```

---

**Derni√®re mise √† jour**: 2025-10-25
**Statut**: ‚úÖ Phase users compl√©t√©e - Pr√™t pour d√©veloppement forum
